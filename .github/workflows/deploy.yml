name: ğŸš€ DÃ©ploiement Automatique Jeroka

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permet de dÃ©clencher manuellement le dÃ©ploiement

env:
  NODE_VERSION: '18'
  DOCKER_COMPOSE_FILE: 'docker-compose.prod.yml'

jobs:
  deploy:
    name: ğŸš€ DÃ©ploiement sur le serveur
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # RÃ©cupÃ¨re tout l'historique Git
      
      - name: ğŸ”§ Configuration de Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: ğŸ” Configuration SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: ğŸ“‹ Ajout de la clÃ© SSH au known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ DÃ©ploiement sur le serveur
        run: |
          echo "ğŸ”„ DÃ©but du dÃ©ploiement sur ${{ secrets.SERVER_HOST }}"
          
          # Connexion SSH et exÃ©cution du script de dÃ©ploiement
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ“ Navigation vers le rÃ©pertoire du projet"
            cd ${{ secrets.SERVER_PROJECT_PATH }}
            
            # VÃ©rifier si le script de dÃ©ploiement existe
            if [ -f "./deploy.sh" ]; then
              echo "ğŸš€ ExÃ©cution du script de dÃ©ploiement automatisÃ©"
              chmod +x ./deploy.sh
              ./deploy.sh
            else
              echo "âš ï¸  Script de dÃ©ploiement non trouvÃ©, utilisation du dÃ©ploiement manuel"
              
              echo "â¹ï¸  ArrÃªt des services Docker"
              docker compose -f docker-compose.prod.yml down || true
              
              echo "ğŸ“¥ Mise Ã  jour du code depuis Git"
              git fetch origin
              git reset --hard origin/main
              git clean -fd
              
              echo "ğŸ”§ Mise Ã  jour des variables d'environnement"
              if [ -f .env ]; then
                echo "âœ… Fichier .env trouvÃ©"
              else
                echo "âš ï¸  Fichier .env manquant - veuillez le crÃ©er"
              fi
              
              echo "ğŸ—ï¸  Construction et dÃ©marrage des services"
              docker compose -f docker-compose.prod.yml up -d --build
              
              echo "â³ Attente du dÃ©marrage des services"
              sleep 30
              
              echo "ğŸ” VÃ©rification du statut des conteneurs"
              docker compose -f docker-compose.prod.yml ps
              
              echo "ğŸ¥ VÃ©rification de la santÃ© des services"
              # VÃ©rification de l'API
              if curl -f http://localhost:3002/health > /dev/null 2>&1; then
                echo "âœ… API accessible"
              else
                echo "âŒ API non accessible"
                docker compose -f docker-compose.prod.yml logs api
              fi
              
              # VÃ©rification du backoffice
              if curl -f http://localhost:3001 > /dev/null 2>&1; then
                echo "âœ… Backoffice accessible"
              else
                echo "âŒ Backoffice non accessible"
                docker compose -f docker-compose.prod.yml logs backoffice
              fi
              
              echo "ğŸ§¹ Nettoyage des images Docker inutilisÃ©es"
              docker image prune -f
              
              echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
            fi
          EOF
      
      - name: ğŸ“Š Notification de succÃ¨s
        if: success()
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi !"
          echo "ğŸŒ Backoffice: https://backoffice.jerokaxperience.fr"
          echo "ğŸ”— API: https://apibackoffice.jerokaxperience.fr"
      
      - name: âŒ Notification d'Ã©chec
        if: failure()
        run: |
          echo "ğŸ’¥ DÃ©ploiement Ã©chouÃ© !"
          echo "VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails."
