name: ğŸ§ª Tests Cypress - DÃ©ploiement et Validation

on:
  push:
    branches: [ develop, feature/* ]
    paths:
      - 'cypress/**'
      - 'backoffice/**'
      - 'api-dashboard/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'cypress/**'
      - 'backoffice/**'
      - 'api-dashboard/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de test'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      run_full_tests:
        description: 'ExÃ©cuter tous les tests (y compris les tests longs)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  # Configuration des tests Cypress
  CYPRESS_BASE_URL: ${{ github.event.inputs.environment == 'production' && 'https://backoffice.jerokaxperience.fr' || 'https://staging-backoffice.jerokaxperience.fr' }}
  API_BASE_URL: ${{ github.event.inputs.environment == 'production' && 'https://apibackoffice.jerokaxperience.fr' || 'https://staging-api.jerokaxperience.fr' }}
  BACKOFFICE_URL: ${{ github.event.inputs.environment == 'production' && 'https://backoffice.jerokaxperience.fr' || 'https://staging-backoffice.jerokaxperience.fr' }}

jobs:
  # Job de dÃ©ploiement sur l'environnement de test
  deploy-test-environment:
    name: ğŸš€ DÃ©ploiement sur l'environnement de test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/develop'
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” Configuration SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: ğŸ“‹ Ajout de la clÃ© SSH au known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ DÃ©ploiement sur l'environnement de test
        run: |
          echo "ğŸ”„ DÃ©ploiement sur l'environnement de test: ${{ github.event.inputs.environment }}"
          
          # Connexion SSH et dÃ©ploiement
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "ğŸ“ Navigation vers le rÃ©pertoire du projet"
            cd ${{ secrets.SERVER_PROJECT_PATH }}
            
            # Configuration Git
            git remote set-url origin https://x-access-token:${{ secrets.TOKEN_GITHUB }}@github.com/JeromeLaquay/Jeroka-backoffice.git
            
            # Mise Ã  jour du code
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            git clean -fd
            
            # DÃ©ploiement selon l'environnement
            if [ "${{ github.event.inputs.environment }}" = "staging" ]; then
              echo "ğŸ—ï¸ DÃ©ploiement sur l'environnement de staging"
              docker compose -f docker-compose.staging.yml up -d --build
            else
              echo "ğŸ—ï¸ DÃ©ploiement sur l'environnement de production"
              docker compose -f docker-compose.prod.yml up -d --build
            fi
            
            # Attendre que les services soient prÃªts
            echo "â³ Attente du dÃ©marrage des services..."
            sleep 60
            
            # VÃ©rification de la santÃ© des services
            echo "ğŸ¥ VÃ©rification de la santÃ© des services..."
            
            # VÃ©rifier l'API
            if curl -f ${{ env.API_BASE_URL }}/health > /dev/null 2>&1; then
              echo "âœ… API accessible"
            else
              echo "âŒ API non accessible"
              exit 1
            fi
            
            # VÃ©rifier le backoffice
            if curl -f ${{ env.BACKOFFICE_URL }} > /dev/null 2>&1; then
              echo "âœ… Backoffice accessible"
            else
              echo "âŒ Backoffice non accessible"
              exit 1
            fi
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
          EOF

  # Job de tests rapides (tests de base)
  quick-tests:
    name: ğŸ§ª Tests rapides
    runs-on: ubuntu-latest
    needs: [deploy-test-environment]
    if: always() && (needs.deploy-test-environment.result == 'success' || github.event_name == 'pull_request')
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cypress/package-lock.json
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          cd cypress
          npm install
          
      - name: ğŸ§ª ExÃ©cution des tests rapides
        run: |
          cd cypress
          echo "ğŸ§ª ExÃ©cution des tests rapides..."
          
          # Configuration des variables d'environnement
          export CYPRESS_BASE_URL="${{ env.CYPRESS_BASE_URL }}"
          export API_BASE_URL="${{ env.API_BASE_URL }}"
          export BACKOFFICE_URL="${{ env.BACKOFFICE_URL }}"
          export TEST_USER_EMAIL="${{ secrets.TEST_USER_EMAIL }}"
          export TEST_USER_PASSWORD="${{ secrets.TEST_USER_PASSWORD }}"
          export ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}"
          export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          
          # Attendre que les services soient prÃªts
          echo "â³ Attente de la disponibilitÃ© des services..."
          sleep 30
          
          # ExÃ©cuter seulement les tests de base
          npm run cypress:run:chrome -- --spec "cypress/e2e/01-basic-setup.cy.ts,cypress/e2e/02-backoffice-basic.cy.ts"
          
      - name: ğŸ“¤ Upload des rapports des tests rapides
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quick-test-reports-${{ github.run_number }}
          path: |
            cypress/reports/
            cypress/screenshots/
            cypress/videos/
          retention-days: 7

  # Job de tests complets (tous les tests)
  full-tests:
    name: ğŸ§ª Tests complets
    runs-on: ubuntu-latest
    needs: [quick-tests]
    if: always() && (needs.quick-tests.result == 'success' && (github.event.inputs.run_full_tests == 'true' || github.event_name == 'push'))
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cypress/package-lock.json
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          cd cypress
          npm install
          
      - name: ğŸ§ª ExÃ©cution des tests complets
        run: |
          cd cypress
          echo "ğŸ§ª ExÃ©cution des tests complets..."
          
          # Configuration des variables d'environnement
          export CYPRESS_BASE_URL="${{ env.CYPRESS_BASE_URL }}"
          export API_BASE_URL="${{ env.API_BASE_URL }}"
          export BACKOFFICE_URL="${{ env.BACKOFFICE_URL }}"
          export TEST_USER_EMAIL="${{ secrets.TEST_USER_EMAIL }}"
          export TEST_USER_PASSWORD="${{ secrets.TEST_USER_PASSWORD }}"
          export ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}"
          export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          
          # ExÃ©cuter tous les tests
          npm run test:ci:chrome
          
          # GÃ©nÃ©rer le rapport consolidÃ©
          npm run test:report
          
      - name: ğŸ“¤ Upload des rapports des tests complets
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-test-reports-${{ github.run_number }}
          path: |
            cypress/reports/
            cypress/screenshots/
            cypress/videos/
          retention-days: 30

  # Job de tests multi-navigateurs
  multi-browser-tests:
    name: ğŸ§ª Tests multi-navigateurs
    runs-on: ubuntu-latest
    needs: [full-tests]
    if: always() && (needs.full-tests.result == 'success' && github.event_name == 'push' && github.ref == 'refs/heads/develop')
    
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cypress/package-lock.json
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          cd cypress
          npm install
          
      - name: ğŸ§ª ExÃ©cution des tests sur ${{ matrix.browser }}
        run: |
          cd cypress
          echo "ğŸ§ª ExÃ©cution des tests sur ${{ matrix.browser }}..."
          
          # Configuration des variables d'environnement
          export CYPRESS_BASE_URL="${{ env.CYPRESS_BASE_URL }}"
          export API_BASE_URL="${{ env.API_BASE_URL }}"
          export BACKOFFICE_URL="${{ env.BACKOFFICE_URL }}"
          export TEST_USER_EMAIL="${{ secrets.TEST_USER_EMAIL }}"
          export TEST_USER_PASSWORD="${{ secrets.TEST_USER_PASSWORD }}"
          export ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}"
          export ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          
          # ExÃ©cuter les tests sur le navigateur spÃ©cifiÃ©
          npm run cypress:run:${{ matrix.browser }}
          
      - name: ğŸ“¤ Upload des rapports pour ${{ matrix.browser }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ matrix.browser }}-${{ github.run_number }}
          path: |
            cypress/reports/
            cypress/screenshots/
            cypress/videos/
          retention-days: 30

  # Job de gÃ©nÃ©ration du rapport consolidÃ©
  generate-consolidated-report:
    name: ğŸ“Š Rapport consolidÃ©
    runs-on: ubuntu-latest
    needs: [multi-browser-tests]
    if: always() && (needs.multi-browser-tests.result == 'success' || needs.multi-browser-tests.result == 'skipped')
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ TÃ©lÃ©chargement des rapports
        uses: actions/download-artifact@v4
        with:
          path: reports/
          
      - name: ğŸ”§ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: cypress/package-lock.json
          
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          cd cypress
          npm install
          
      - name: ğŸ“Š GÃ©nÃ©ration du rapport consolidÃ©
        run: |
          cd cypress
          echo "ğŸ“Š GÃ©nÃ©ration du rapport consolidÃ©..."
          
          # Fusionner tous les rapports
          npx mochawesome-merge reports/*/mochawesome.json > reports/consolidated-report.json
          
          # GÃ©nÃ©rer le rapport HTML consolidÃ©
          npx marge reports/consolidated-report.json --reportDir reports/consolidated --inline
          
      - name: ğŸ“¤ Upload du rapport consolidÃ©
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-test-report-${{ github.run_number }}
          path: cypress/reports/consolidated/
          retention-days: 30
          
      - name: ğŸ’¬ Commentaire sur la PR avec le rapport
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Lire le rapport consolidÃ©
            const reportPath = 'cypress/reports/consolidated/mochawesome.html';
            if (fs.existsSync(reportPath)) {
              const comment = `## ğŸ§ª Rapport des Tests Cypress
              
              Les tests Cypress ont Ã©tÃ© exÃ©cutÃ©s sur l'environnement **${{ github.event.inputs.environment || 'staging' }}**.
              
              ### RÃ©sultats:
              - âœ… Tests rapides: ${{ needs.quick-tests.result }}
              - âœ… Tests complets: ${{ needs.full-tests.result }}
              - âœ… Tests multi-navigateurs: ${{ needs.multi-browser-tests.result }}
              
              ### Environnement de test:
              - ğŸŒ Backoffice: ${{ env.BACKOFFICE_URL }}
              - ğŸ”— API: ${{ env.API_BASE_URL }}
              
              ### Rapport dÃ©taillÃ©:
              Le rapport complet est disponible dans les artifacts de ce workflow.
              
              ---
              *GÃ©nÃ©rÃ© automatiquement par GitHub Actions*`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # Job de notification
  notify-results:
    name: ğŸ“¢ Notification des rÃ©sultats
    runs-on: ubuntu-latest
    needs: [generate-consolidated-report]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notification de succÃ¨s
        if: needs.generate-consolidated-report.result == 'success'
        run: |
          echo "ğŸ‰ Tests Cypress terminÃ©s avec succÃ¨s !"
          echo "ğŸ“Š Rapport consolidÃ© gÃ©nÃ©rÃ©"
          echo "ğŸŒ Environnement testÃ©: ${{ env.CYPRESS_BASE_URL }}"
          
      - name: ğŸ“¢ Notification d'Ã©chec
        if: needs.generate-consolidated-report.result == 'failure'
        run: |
          echo "ğŸ’¥ Tests Cypress Ã©chouÃ©s !"
          echo "ğŸ” VÃ©rifiez les logs et rapports pour plus de dÃ©tails"
          echo "ğŸŒ Environnement testÃ©: ${{ env.CYPRESS_BASE_URL }}"
